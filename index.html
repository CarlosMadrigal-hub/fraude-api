<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detecci칩n de Fraude Bancario (K-Means)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --danger: #dc2626;
            --success: #10b981;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1000px; /* Un poco m치s ancho para las gr치ficas */
            width: 100%;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        h1 { margin-top: 0; color: var(--primary); text-align: center; }
        h2 { border-bottom: 2px solid #f3f4f6; padding-bottom: 10px; margin-top: 30px; }
        
        .form-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }

        input[type="number"] {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
            width: 100px;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background 0.3s;
        }

        button:hover { background-color: #1d4ed8; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: #eff6ff;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #bfdbfe;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Estilos para las Gr치ficas */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Responsividad para gr치ficas en m칩viles */
        @media (max-width: 768px) {
            .charts-container { grid-template-columns: 1fr; }
        }

        .table-container { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; }

        .high-risk { background-color: #fef2f2; color: var(--danger); font-weight: bold; }
        .risk-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; }
        .badge-danger { background-color: #fee2e2; color: #991b1b; }
        .badge-safe { background-color: #d1fae5; color: #065f46; }

        #loading, #error, #results { display: none; }
        #error { color: var(--danger); text-align: center; margin-top: 10px; }

    </style>
</head>
<body>

    <div class="container">
        <div class="card">
            <h1>游댌 Analizador de Clusters K-Means</h1>
            
            <div class="form-group">
                <label for="clusters">N칰mero de Clusters (2-20):</label>
                <input type="number" id="clusters" min="2" max="20" value="5">
                <button onclick="analyzeData()" id="analyzeBtn">Analizar</button>
            </div>
            <div id="error"></div>
        </div>

        <div id="loading" style="text-align: center; margin: 2rem;">
            <p>Procesando algoritmo K-Means... esto puede tardar unos segundos.</p>
        </div>

        <div id="results" class="card">
            <h2>游늵 M칠tricas Generales</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div>Purity Score</div>
                    <div class="metric-value" id="purity">0</div>
                </div>
                <div class="metric-card">
                    <div>Silhouette Score</div>
                    <div class="metric-value" id="silhouette">0</div>
                </div>
                <div class="metric-card">
                    <div>Calinski Harabasz</div>
                    <div class="metric-value" id="calinski">0</div>
                </div>
            </div>

            <h2>游늳 Visualizaci칩n Gr치fica</h2>
            <div class="charts-container">
                <div class="chart-wrapper">
                    <canvas id="barChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <h2>丘멆잺 Detalle por Cluster</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Cluster ID</th>
                            <th>Total Muestras</th>
                            <th>Fraudes</th>
                            <th>% Fraude</th>
                            <th>Riesgo</th>
                        </tr>
                    </thead>
                    <tbody id="clusterTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para guardar las instancias de los gr치ficos
        let barChartInstance = null;
        let pieChartInstance = null;

        async function analyzeData() {
            const nClusters = document.getElementById('clusters').value;
            const btn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const errorDiv = document.getElementById('error');
            const tableBody = document.getElementById('clusterTableBody');

            errorDiv.innerText = '';
            results.style.display = 'none';
            loading.style.display = 'block';
            btn.disabled = true;

            try {
                // LLAMADA A TU API
                const response = await fetch('http://127.0.0.1:8000/api/detect-fraud/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ n_clusters: parseInt(nClusters) })
                });

                if (!response.ok) throw new Error(`Error del servidor`);
                const data = await response.json();

                // 1. LLENAR M칄TRICAS
                document.getElementById('purity').innerText = data.metrics.purity_score;
                document.getElementById('silhouette').innerText = data.metrics.silhouette_score;
                document.getElementById('calinski').innerText = data.metrics.calinski_harabasz;

                // 2. LLENAR TABLA
                tableBody.innerHTML = '';
                
                // Preparar datos para gr치ficas
                const labels = [];
                const fraudData = [];
                const totalData = [];
                const backgroundColors = [];

                data.clusters_analysis.forEach(cluster => {
                    const isRisk = cluster.is_high_risk;
                    
                    // Datos para tabla
                    const row = `
                        <tr class="${isRisk ? 'high-risk' : ''}">
                            <td><strong>${cluster.cluster_id}</strong></td>
                            <td>${cluster.total_samples}</td>
                            <td>${cluster.fraud_samples}</td>
                            <td>${cluster.fraud_percentage}%</td>
                            <td><span class="risk-badge ${isRisk ? 'badge-danger' : 'badge-safe'}">${isRisk ? 'ALTO' : 'Normal'}</span></td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;

                    // Datos para gr치ficas
                    labels.push(`Cluster ${cluster.cluster_id}`);
                    fraudData.push(cluster.fraud_samples);
                    totalData.push(cluster.total_samples);
                    // Color rojo si es riesgo, azul si es normal
                    backgroundColors.push(isRisk ? '#dc2626' : '#2563eb');
                });

                // 3. GENERAR GR츼FICAS
                renderCharts(labels, fraudData, totalData, backgroundColors);

                results.style.display = 'block';

            } catch (err) {
                console.error(err);
                errorDiv.innerText = 'Error al conectar con la API. Revisa la consola.';
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }

        function renderCharts(labels, fraudData, totalData, colors) {
            // Destruir gr치ficas anteriores si existen para evitar conflictos
            if (barChartInstance) barChartInstance.destroy();
            if (pieChartInstance) pieChartInstance.destroy();

            // Gr치fico 1: Comparativa Total vs Fraudes (Escala Logar칤tmica para ver mejor los fraudes)
            const ctxBar = document.getElementById('barChart').getContext('2d');
            barChartInstance = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Muestras',
                            data: totalData,
                            backgroundColor: '#e5e7eb',
                            order: 2
                        },
                        {
                            label: 'Fraudes (Rojo)',
                            data: fraudData,
                            backgroundColor: '#dc2626',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Muestras vs Fraudes (Escala Log)' }
                    },
                    scales: {
                        // Usamos escala logar칤tmica porque los fraudes son muy pocos comparados con el total
                        y: { type: 'logarithmic' } 
                    }
                }
            });

            // Gr치fico 2: Distribuci칩n de Fraudes (Dona)
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            pieChartInstance = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: fraudData,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: '쮻칩nde se concentran los fraudes?' },
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    </script>
</body>
</html>